---
title: "`r paste0('Macroinvertebrate Biotic Integrity Report for ', params$user_title)`"
author: "SMSC Natural Resources Department"
date: "Generated on `r params$report_date`"
output: 
  pdf_document:
    keep_tex: true
header-includes:
  - \usepackage[table]{xcolor}
  - \usepackage{booktabs}
  - \usepackage[fontsize=11pt]{scrextend}
  - \usepackage{titlesec}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{placeins}
  - \titleformat{\section}{\normalfont\Large\bfseries}{\thesection}{1em}{}
  - \titlespacing*{\section}{0pt}{0.5em}{0.2em}
  - \titleformat{\subsection}{\normalfont\large\bfseries}{\thesubsection}{0.5em}{}
  - \titlespacing*{\subsection}{0pt}{0.4em}{0.2em}
geometry: margin=1in
params:
  user_title: "Default Title"
  user_date: "Default Date"
  report_date: !r add_ordinal_suffix(Sys.Date(), style = "%Y-%m-%d")
  data: NA
  comparison_metrics: NA
  table_img: NA
---

```{r packages, echo=FALSE, warning = FALSE, message = FALSE}
library(knitr)
library(grid)
library(gridExtra)
library(kableExtra)
library(dplyr)
library(tidyr)
library(ggplot2)
```

# **IBI Overview**
This report provides a summary of the biotic integrity of `r params$user_title`, based on macroinvertebrate organisms collected on `r add_ordinal_suffix(params$user_date, style = "%m/%d/%Y")`. The Index of Biotic Integrity (IBI) method seeks to quantify
water quality and ecological impairment based on biotic factors, such as fish or macroinvertebrates. This
specific IBI protocol was developed for the Shakopee Mdewakanton Sioux Community, and as such, should
not be compared to data collected under different protocols.

The IBI score ranges from 0 to 50, with 0 indicating substantial impairment and 50 indicating minimal impairment. Staff identify each individual organism to the lowest taxonomic level practicable, and then calculate the score using both the number of unique taxa and their relative abundances. When the value of a metric is calculated above 10 or below 0, it is adjusted to remain within valid bounds.

*Note: This report was generated automatically. Interpretations provided herein are preliminary and intended for informational purposes only. Detailed analysis and conclusions should be confirmed through further review.*

# Discussion
```{r metric table, echo=FALSE, fig.align="center", dpi=500, out.width = "100%"}
metrics <- params$data %>%
  select(metric_name, metric_value, metric_score, adj_score) %>%
  mutate(across(c(metric_value, metric_score, adj_score), ~round(.x, 4)),
    metric_value = replace_na(as.character(metric_value), ""),
    metric_score = replace_na(as.character(metric_score), "")
  ) %>%
  rename("Metric Name" = "metric_name",
         "Metric Value" = "metric_value",
         "Metric Score" = "metric_score",
         "Adjusted Score" = "adj_score")

table_text <- paste0("Table 1: All values and calculated metrics for ", params$user_title)

knitr::asis_output(paste0(
  "\\begin{center}\n",
  "    \\textit{", escape_latex(table_text), "}\\par\n",
  "\\end{center}\n"
))

kable(metrics, booktabs = TRUE, format = "latex", longtable = FALSE, linesep = "") %>%
  kable_styling(
    latex_options = c("striped", "hold_position"),
    font_size = 10
  )
```

```{r setting parameters, echo = FALSE}
eot_taxa <- params$data$adj_score[params$data$metric_name == "EOT Taxa: "]
snail_taxa <- params$data$adj_score[params$data$metric_name == "Snail Taxa: "]
all_taxa <- params$data$adj_score[params$data$metric_name == "All Taxa: "]
corixid_metric <- params$data$adj_score[params$data$metric_name == "Corixid Metric: "]
eot_abund <- params$data$adj_score[params$data$metric_name == "Abundance EOT: "]
total_score <- params$data$adj_score[params$data$metric_name == "IBI Score (0-50)"]
```

## Total Score

```{r total score interpretation, echo = FALSE, results = 'asis'}
if(!is.null(total_score) && !is.na(total_score)) {
  if(total_score >= 38) {
    cat("A total IBI score of ", round(total_score, 2), " indicates that the wetland is in excellent condition with minimal impairment. The high score reflects a robust and diverse macroinvertebrate community, suggesting high water quality and ecological integrity.\n\n")
  } else if(total_score >= 25) {
    cat("With a total IBI score of ", round(total_score, 2), ", the wetland shows moderate impairment. While the macroinvertebrate community is still relatively diverse, there are signs of ecological stress that could be related to habitat degradation or pollution.\n\n")
  } else if(total_score >= 10) {
    cat("A total IBI score of ", round(total_score, 2), " suggests significant impairment. This low score highlights notable ecological degradation and suggests that the wetland is considerably impaired, potentially from pollutants or habitat disruption.\n\n")
  } else if(total_score < 10) {
    cat("Invalid IBI Score; score too low\n\n")
  }
} else {
  "IBI score data is not available at this time.\n\n"
}
```

## Metric Scores

```{r metric scores discussions, echo = FALSE, results = 'asis'}
# EOT Taxa
if(!is.null(eot_taxa) && !is.na(eot_taxa)) {
  if(eot_taxa >= 5) {
    cat("- EOT Taxa: A score of ", round(eot_taxa, 2), " suggests excellent diversity of dragonflies, mayflies, caddisflies, and damselflies. This high diversity indicates a robust predator community, reflective of minimal ecological disturbance and high water quality.\n\n")
  } else if(eot_taxa >= 2.5) {
    cat("- EOT Taxa: With a score of ", round(eot_taxa, 2), ", the diversity of dragonflies, mayflies, caddisflies, and damselflies is moderate. While this indicates some resilience, it may also point to early signs of stress impacting these predatory taxa.\n\n")
  } else if (eot_taxa > 0){
    cat("- EOT Taxa: A low score of ", round(eot_taxa, 2), " implies limited diversity among dragonflies, mayflies, caddisflies, and damselflies. This reduction in predatory diversity can be an early indicator of impairment or environmental stress.\n\n")
  } else if (eot_taxa == 0){
    cat("- EOT Taxa: A score of ", round(eot_taxa, 2), " implies no dragonflies, mayflies, caddisflies, or damselflies were found in the sample. This absence of predatory diversity could be a sign of significant impairment or environmental stress.\n\n")
  }
} else {
  cat("EOT Taxa data is not available.\n\n")
}

# Snail Taxa
if(!is.null(snail_taxa) && !is.na(snail_taxa)) {
  if(snail_taxa >= 6.5) {
    cat("- Snail Taxa: A high diversity score of ", round(snail_taxa, 2), " indicates that the wetland supports a broad range of gastropod species. While snails are generally less sensitive to water quality changes, such diversity typically correlates with favorable environmental conditions.\n\n")
  } else if(snail_taxa >= 2) {
    cat("- Snail Taxa: With a score of ", round(snail_taxa, 2), ", the snail community is moderately diverse. This suggests that while the wetland sustains multiple gastropod species, there may be underlying pressures that limit their full complement.\n\n")
  } else if (eot_taxa > 0){
    cat("- Snail Taxa: A low diversity score of ", round(snail_taxa, 2), " may reflect environmental challenges affecting gastropods, potentially signaling issues with water quality or habitat conditions.\n\n")
  } else if (eot_taxa == 0){
    cat("- Snail Taxa: A diversity score of ", round(eot_taxa, 2), " implies no gastropod taxa were found in the sample. This absence could indicate significant impairment or environmental stress.\n\n")
  }
} else {
  cat("Snail Taxa data is not available.\n\n")
}

# Total Taxa
if(!is.null(all_taxa) && !is.na(all_taxa)) {
  if(all_taxa >= 15) {
    cat("- All Taxa: A total taxa score of ", round(all_taxa, 2), " highlights a highly diverse macroinvertebrate community, indicative of excellent overall wetland health and ecological resilience.\n\n")
  } else if(all_taxa >= 8) {
    cat("- All Taxa: With a score of ", round(all_taxa, 2), ", the overall diversity is moderate. This suggests some ecological impact, though the wetland still maintains a fair level of biological complexity.\n\n")
  } else {
    cat("- All Taxa: A low total diversity score of ", round(all_taxa, 2), " suggests a diminished macroinvertebrate community, which could be symptomatic of significant ecological impairment.\n\n")
  }
} else {
  cat("All Taxa data is not available.\n\n")
}

# Corixid Metric
if(!is.null(corixid_metric) && !is.na(corixid_metric)) {
  if(corixid_metric == 10) {
    cat("- Corixid Metric: A score of ", round(corixid_metric, 2), " indicates no corixids were found in the sample, suggesting minimal nutrient loading or ecological impairment.\n\n")
  } else if (corixid_metric >= 9.90) {
    cat("- Corixid Metric: A score of ", round(corixid_metric, 2), " suggests a favorable balance between corixids and other invertebrate groups, indicating minimal nutrient loading or impairment.\n\n")
  } else if(corixid_metric >= 9.70) {
    cat("- Corixid Metric: With a score of ", round(corixid_metric, 2), ", there is a moderate shift in community composition, possibly an early sign of nutrient loading or ecological imbalance.\n\n")
  } else {
    cat("- Corixid Metric: A lower score of ", round(corixid_metric, 2), " indicates a higher dominance of corixids than most of the other surveyed wetlands, possibly associated with ecological impairment such as nutrient enrichment.\n\n")
  }
} else {
  cat("Corixid Metric data is not available.\n\n")
}

# Pterygota Abundance
if(!is.null(eot_abund) && !is.na(eot_abund)) {
  if(eot_abund >= 3) {
    cat("- Abundance EOT: An adjusted value of ", round(eot_abund, 2), " indicates a strong proportion of dragonflies, mayflies, caddisflies, or damselflies taxa in the sample, reflecting high water quality and minimal environmental stress.\n\n")
  } else if(eot_abund >= 2) {
    cat("- Abundance EOT: With a score of ", round(eot_abund, 2), ", the abundance of dragonflies, mayflies, caddisflies, or damselflies is moderate. While these taxa are present, there may be some underlying stress factors.\n\n")
  } else if (eot_abund > 0) {
    cat("- Abundance EOT: A low score of ", round(eot_abund, 2), " points to a reduced presence of these sensitive organisms, which can be an early warning sign of substantial environmental impairment.\n\n")
  } else if (eot_abund == 0) {
    cat("- Abundance EOT: A score of ", round(eot_abund, 2), " indicates no dragonflies, mayflies, caddisflies, or damselflies were found in the sample. This absence may suggest significant impairment or environmental stress.\n\n")
  }
} else {
  cat("Abundance EOT data is not available.\n\n")
}
```

## Relative Health

### Metrics Comparison

The boxplots in figure 1 compare the metric scores from `r params$user_title` with scores collected from other wetlands by the natural resources department. The NRD makes an effort to conduct all IBI surveys with the same temporal and spatial conditions to ensure meaningful comparisons.

```{r comparison-boxplot, warning = FALSE, echo = FALSE}
comparison_other <- subset(params$comparison_metrics, metric_name != "IBI Score (0-50)")
current_other    <- subset(params$data, metric_name != "IBI Score (0-50)")

figure1_text <- escape_latex(paste0("Distributions of calculated metric scores from all surveyed sites. Red lines indicate scores from ", params$user_title))

comp_boxes <- ggplot(comparison_other, aes(x = metric_name, y = adj_score)) +
  geom_boxplot() +
  labs(x = "", y = "Adjusted Score") +
  geom_segment(data = current_other,
               aes(x = as.numeric(factor(metric_name,
                                         levels = unique(comparison_other$metric_name))) - 0.4,
                   xend = as.numeric(factor(metric_name,
                                           levels = unique(comparison_other$metric_name))) + 0.4,
                   y = adj_score,
                   yend = adj_score),
               color = "red", size = 1) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

plot_path <- "comparison-boxplot.pdf"
ggsave(filename = plot_path, plot = comp_boxes, width = 3.5, height = 3)
```

```{r LaTeX output, echo = FALSE, results = 'asis'}
cat(paste0(
  "\n",
  "\\begin{wrapfigure}{r}{0.6\\textwidth}\n",
  "  \\centering\n",
  "  \\vspace{-10pt}\n",
  "  \\includegraphics[width=0.6\\textwidth]{", plot_path, "}\n",
  "  \\caption{\\textit{", figure1_text, "}}\n",
  "  \\vspace{-10pt}\n",
  "\\end{wrapfigure}\n"
))
```

```{r comparative text, warning = FALSE, echo = FALSE, results = 'asis', fig.pos = 'H'}
# Determine general performance compared to other sites
metric_summary <- merge(
  aggregate(adj_score ~ metric_name, comparison_other, median),
  current_other[, c("metric_name", "adj_score")],
  by = "metric_name",
  suffixes = c("_median", "_current")
) %>%
  mutate(metric_name = gsub(": ", "", metric_name))

higher_metrics <- metric_summary$metric_name[metric_summary$adj_score_current > metric_summary$adj_score_median * 1.25]
lower_metrics  <- metric_summary$metric_name[metric_summary$adj_score_current < metric_summary$adj_score_median * 0.75]

general_comparison <- median(metric_summary$adj_score_current / metric_summary$adj_score_median, na.rm = TRUE)

however <- FALSE

if(general_comparison >= 1.25) {
  cat("The metric scores for this wetland are generally higher than other sampled wetlands, indicating relatively better conditions overall.\n\n")
} else if(general_comparison <= 0.75) {
  cat("The metric scores for this wetland are generally lower than other sampled wetlands, suggesting relatively poorer conditions or higher impairment.\n\n")
} else {
  cat("The metric scores for this wetland are generally similar to other sampled wetlands.\n\n")
}

if(length(higher_metrics) > 0 && general_comparison >= 1.25) {
  cat("Metrics that were notably higher than average include: ", paste(higher_metrics, collapse = ", "), ".\n\n", sep = "")
}

if(length(higher_metrics) > 0 && general_comparison <= 0.75 || length(higher_metrics) > 0 && abs(general_comparison - 1) <= 0.1) {
  cat("However, these metrics were notably higher than average: ", paste(higher_metrics, collapse = ", "), ".\n\n", sep = "")
  however <- TRUE
}

if(length(lower_metrics) > 0 && general_comparison <= 0.75) {
  cat("Metrics that were notably lower than average include: ", paste(lower_metrics, collapse = ", "), ".\n\n", sep = "")
}

if(length(lower_metrics) > 0 & general_comparison >= 1.25 & however == FALSE|| 
   length(lower_metrics) > 0 && abs(general_comparison - 1) <= 0.1 & however == FALSE) {
  cat("However, these metrics were notably lower than average: ", paste(lower_metrics, collapse = ", "), ".\n\n", sep = "")
}

if(length(lower_metrics) > 0 & general_comparison >= 1.25 & however == TRUE|| 
   length(lower_metrics) > 0 && abs(general_comparison - 1) <= 0.1 & however == TRUE) {
  cat("Additionally, these metrics were notably lower than average: ", paste(lower_metrics, collapse = ", "), ".\n\n", sep = "")
}

if(length(higher_metrics) == 0 && length(lower_metrics) == 0) {
  cat("There are no metrics with notably higher or lower scores compared to other sites.\n\n")
}
```

\clearpage


### Total Score Comparison

The boxplot in figure 2 compares the total IBI score from `r params$user_title` with other wetlands surveyed by the natural resources department.

```{r total-boxplot, warning = FALSE, echo = FALSE}
comparison_total <- subset(params$comparison_metrics, metric_name == "IBI Score (0-50)")
current_total    <- subset(params$data, metric_name == "IBI Score (0-50)")

figure2_text <- escape_latex(paste0("Distribution of total IBI score from all surveyed sites. The red line indicates the total score for ", params$user_title))

total_box <- ggplot(comparison_total, aes(x = metric_name, y = adj_score)) +
  geom_boxplot() +
  labs(x = "", y = "Total Adjusted Score") +
  geom_segment(data = current_total,
               # Since there's only one box, we can hardcode the x-range:
               aes(x = 0.6, xend = 1.4, y = adj_score, yend = adj_score),
               color = "red", size = 1) +
  theme_minimal()

tot_path <- "total-boxplot.pdf"
ggsave(filename = tot_path, plot = total_box, width = 3.5, height = 3)
```

```{r LaTeX output 2, echo = FALSE, results = 'asis', fig.pos = 'H'}
cat(paste0(
  "\n",
  "\\begin{wrapfigure}{l}{0.6\\textwidth}\n",
  "  \\centering\n",
  "  \\vspace{-10pt}\n",
  "  \\includegraphics[width=0.6\\textwidth]{", tot_path, "}\n",
  "  \\caption{\\textit{", figure2_text, "}}\n",
  "  \\vspace{-10pt}\n",
  "\\end{wrapfigure}\n"
))
```

```{r total int text, warning = FALSE, echo = FALSE, results = 'asis'}
diff_tot <- sum(current_total$adj_score) - median(comparison_total$adj_score)

if(diff_tot < -0.1) {
  cat("The total score is ", paste0(abs(round(diff_tot, 2))), " points lower than the median score, indicating a relatively more impaired system.\n\n")
} 

if(diff_tot >= -0.1 & diff_tot <= 0.1) {
  cat("The total IBI score for this wetland is roughly equal to the median total score.\n\n")
} 

if(diff_tot > 0.1) {
  cat("The total score is ", paste0(abs(round(diff_tot, 2))), " points higher than the median score, indicating a relatively less impaired system.\n\n")
}
```

```{r fake-section-title, results = 'asis', echo = FALSE}
cat("\\vspace{1.5em}\n\\textbf{\\Large Methods}\\\ ")
```

### Sampling

Macroinvertebrate sampling is conducted annually, typically from June through early July, though exact timing varies based on seasonal weather conditions. Accurate timing is critical, as sampling too early may result in collecting immature larvae that cannot be reliably identified to the genus level.

At each wetland site, two separate samples are collected within a 10-meter radius, preferably from the emergent vegetation zone. If an emergent zone is absent, samples are collected from the vegetative zone with the greatest extent. Each of the two samples consists of two separate dipnet efforts performed using a heavy-handled D-frame dip net with a 500-micron mesh. Each dipnet effort involves vigorous sweeps through the water column and associated vegetation, intentionally avoiding substrate material. If the substrate is inadvertently disturbed, the effort is repeated at a different location within the sampling radius.

Following collection, samples are combined and processed on-site. The combined sample is poured onto a framed 1/2-inch hardware cloth positioned over a pan, allowing macroinvertebrates to separate naturally from vegetation debris. During a period of approximately 10 minutes, organisms crawl or fall into the pan while staff manually sort remaining organisms from the vegetation using forceps. The sorted organisms are then rinsed through a 200-micron sieve to remove excess water and preserved in an alcohol solution of at least 80% concentration for subsequent identification.

### Identification & Scoring

Identification and enumeration of macroinvertebrates occur during the winter months, well after sample collection. Staff utilize stereoscopes (2x and 4x magnification), dissection tools, and Petri dishes to systematically identify organisms to the lowest practicable taxonomic level—at minimum to Family, typically to Genus, and ideally to Species.

### Metrics Used for Assessment

The ecological health of each wetland is assessed using multiple metrics derived from the collected macroinvertebrate data. Metrics are selected to represent sensitivity or tolerance to disturbance:

- EOT Taxa: The number of predatory insects in the orders Ephemeroptera, Odonata, and Trichoptera (dragonflies, damselflies, mayflies, caddisflies). These taxa are highly sensitive to pollution, so a higher diversity indicates minimal disturbance.

- Snail Taxa: The number of snail species (gastropods). Snails are somewhat more tolerant than EOT taxa, but greater diversity still tends to reflect favorable water conditions.

- All Taxa: Overall macroinvertebrate diversity (total count of unique taxa). This is the broadest measure—high species richness typically means good ecological health.

- Corixid Metric: Ratio of corixids (algae-feeding water boatmen) to other aquatic insects. Unlike the others, higher corixid dominance can signal nutrient-enriched or impaired conditions.

- Abundance EOT: The proportion (rather than just number of taxa) of damselflies, dragonflies, etc. in the sample. High representation of these sensitive insects indicates minimal disturbance.

### Calculation of Metric Scores

Individual metrics are scored based on their known responses to environmental disturbances. Scoring methods vary depending on the directionality of the metric's response to ecological disturbance:

- For metrics that decrease as disturbance increases:

$$
\text{Score} = 
\left(
  \frac{\text{metric value} - \text{minimum value}}
        {\text{95th percentile value} - \text{minimum value}}
\right)
\times 10
$$

- For metrics that increase as disturbance increases:

$$
\text{Score} = 
\left(
10 - 
  \frac{\text{metric value} - \text{5th percentile value}}
        {\text{maximum value} - \text{5th percentile value}}
\right)
\times 10
$$

The boundary values (minimum, maximum, 95th percentile, and 5th percentile) used in these formulas are derived from historical macroinvertebrate surveys conducted by the Minnesota Pollution Control Agency in the same ecoregion. They represent typical extremes of the data distribution for each metric in local wetlands, providing a context-specific scale against which current measurements are standardized.
