---
title: "Macroinvertebrate IBI Data Summary for: "
subtitle: "`r paste0(params$user_title)`"
date: "Generated on `r params$report_date`"
output: 
  pdf_document:
    latex_engine: xelatex
fontsize: 11pt
header-includes:
  - \usepackage{booktabs}
  - \usepackage[familydefault,light]{Chivo}
  - \usepackage[T1]{fontenc}
  - \usepackage{titling}
  - \usepackage[table]{xcolor}
  - \pretitle{\begin{flushright}}
  - \posttitle{\end{flushright}}
  - \predate{\begin{flushright}}
  - \postdate{\end{flushright}}
params:
  user_title: "Default Title"
  user_date: "Default Date"
  report_date: !r macroibi:::add_ordinal_suffix(Sys.Date(), style = "%Y-%m-%d")
  metric_data: NA
  comparison_metrics: NA
  raw_data: NA
  taxonomy: NA
---

```{r packages, echo=FALSE, warning = FALSE, message = FALSE}
library(knitr)
library(grid)
library(gridExtra)
library(kableExtra)
library(dplyr)
library(tidyr)
library(ggplot2)
```

```{r, echo=FALSE, warning = FALSE, message = FALSE}
metrics <- params$metric_data %>%
  select(metric_name, metric_value, metric_score, adj_score) %>%
  mutate(across(c(metric_value, metric_score, adj_score), ~round(.x, 4)),
    metric_value = replace_na(as.character(metric_value), ""),
    metric_score = replace_na(as.character(metric_score), "")
  ) %>%
  rename("Metric Name" = "metric_name",
         "Metric Value" = "metric_value",
         "Metric Score" = "metric_score",
         "Adjusted Score" = "adj_score")

table_text <- paste0("Table 1: All values and calculated metrics for ", params$user_title)

asis_output(paste0(  "\\begin{center}\n",
  "\\textit{", escape_latex(table_text), "}\\par\n",
  "\\end{center}\n"
  ))

kable(metrics, booktabs = TRUE, format = "latex", longtable = FALSE, linesep = "") %>%
  kable_styling(
    latex_options = c("striped", "hold_position"),
    font_size = 10
  )
```

```{r boxplots, echo=FALSE, warning = FALSE, message = FALSE, include = FALSE}
comparison_other <- subset(params$comparison_metrics, metric_name != "IBI Score (0-50)")
current_other    <- subset(params$metric_data, metric_name != "IBI Score (0-50)")

comp_boxes <- ggplot(comparison_other, aes(x = metric_name, y = adj_score)) +
  geom_boxplot() +
  labs(x = "", y = "Adjusted Score") +
  geom_segment(data = current_other,
               aes(x = as.numeric(factor(metric_name,
                                         levels = unique(comparison_other$metric_name))) - 0.4,
                   xend = as.numeric(factor(metric_name,
                                           levels = unique(comparison_other$metric_name))) + 0.4,
                   y = adj_score,
                   yend = adj_score),
               color = "red", size = 1) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

comparison_total <- subset(params$comparison_metrics, metric_name == "IBI Score (0-50)")
current_total    <- subset(params$metric_data, metric_name == "IBI Score (0-50)")

total_box <- ggplot(comparison_total, aes(x = metric_name, y = adj_score)) +
  geom_boxplot() +
  labs(x = "", y = "Total Adjusted Score") +
  geom_segment(data = current_total,
               aes(x = 0.6, xend = 1.4, y = adj_score, yend = adj_score),
               color = "red", size = 1) +
  theme_minimal()

figure1_text <- paste0("Figures 1 & 2: Distributions of calculated metric scores from all surveyed sites (left). Distribution of total IBI score from all surveyed sites (right). The red lines indicate the score for ", params$user_title)

plots <- grid.arrange(comp_boxes, total_box, nrow = 1)

plotpath <- file.path(getwd(), "combinedplots.pdf")

ggsave(filename = plotpath, plot = plots)
```

```{r, echo = FALSE}
knitr::asis_output(paste0(
  "\\resizebox{\\textwidth}{!}{%\n",
  "\\begin{minipage}{\\textwidth}\n",
  "\\includegraphics{", plotpath, "}\n",
  "\\textit{", escape_latex(figure1_text), "}\\par\n",
  "\\end{minipage}%\n",
  "}\n"
))
```

```{r, echo=FALSE, warning = FALSE, message = FALSE}
# Summarize counts
raw_summary <- params$raw_data %>%
  group_by(Taxon) %>%
  summarise(count = sum(Dipnet1, Dipnet2, na.rm = TRUE), .groups = "drop")

observed_taxa <- raw_summary$Taxon

# Get taxon metadata with levels
taxonomy_trimmed <- params$taxonomy %>%
  filter(taxon %in% observed_taxa | tsn %in% params$taxonomy$parentTsn) %>%
  select(taxon, tsn, parentTsn, level)

# Restrict to only observed + their parents
tree_data <- taxonomy_trimmed %>%
  filter(tsn %in% taxonomy_trimmed$tsn | parentTsn %in% taxonomy_trimmed$tsn)

# Recursive traversal for topological order
get_ordered_taxa <- function(df, parent = NA) {
  children <- df %>% filter(is.na(parentTsn) & is.na(parent) | parentTsn == parent)
  result <- character(0)

  for (i in seq_len(nrow(children))) {
    child <- children$taxon[i]
    tsn <- children$tsn[i]

    result <- c(result, child)  # always include current node
    result <- c(result, get_ordered_taxa(df, parent = tsn))
  }
  result
}

ordered_taxa <- get_ordered_taxa(tree_data)

# Build expanded table

taxa_expanded <- params$taxonomy %>%
  filter(taxon %in% observed_taxa) %>%
  select(taxon, tsn, parentTsn, level) %>%
  left_join(params$taxonomy %>% select(tsn, parent_taxon = taxon), by = c("parentTsn" = "tsn")) %>%
  left_join(raw_summary, by = c("taxon" = "Taxon")) %>%
  mutate(
    indent_level = case_when(
      is.na(parent_taxon) ~ 0,
      parent_taxon %in% observed_taxa ~ 1,
      TRUE ~ 0
    ),
    Taxon_display = paste0("\\textit{", taxon, "}"),
    Taxon_display = case_when(
      indent_level == 0 ~ Taxon_display,
      indent_level == 1 ~ paste0("\\hspace{1em}— ", Taxon_display),
      indent_level == 2 ~ paste0("\\hspace{2em}— ", Taxon_display),
      TRUE ~ Taxon_display
    )
  ) %>%
  mutate(taxon = factor(taxon, levels = ordered_taxa)) %>%
  arrange(taxon)

# Final kable table output

final_text <- paste0("Table 2: All taxa observed in the sample from ", params$user_title, " and the number observed. The taxon level is also noted. If an observed taxa is a child of another observed taxa, that is noted with an indent. Parent taxa are not considered unique when calculating metric scores.")

asis_output(paste0(
  "\\begin{center}\n",
  "  \\begin{minipage}{0.8\\textwidth}\n",
  "    \\raggedright\n",
  "    \\textit{", escape_latex(final_text), "}\\par\n",
  "  \\end{minipage}\n",
  "\\end{center}\n"
))

taxa_expanded %>%
  select(Taxon_display, level, count) %>%
  kable(format = "latex", booktabs = TRUE, escape = FALSE,
        col.names = c("Taxon", "Level", "Count"),
        linesep = "") %>%
  kable_styling(latex_options = c("striped", "hold_position"))
```


