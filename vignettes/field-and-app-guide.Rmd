---
title: "Field Sampling & App Guide"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Field Sampling & App Guide}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval = FALSE
)
```

This vignette is adapted from the full
[Field and App Guide](https://github.com/aomop/MacroIBI/blob/main/docs/FIELD_AND_APP_GUIDE_v2.md)
and covers the complete workflow from field sampling through IBI calculation.

## 1. Overview

This guide explains how to collect, sort, identify, and score wetland
macroinvertebrates using the MPCA protocol and the MacroIBI R/Shiny
application. No prior R experience is required --- the installation section
walks you through setup step-by-step.

## 2. Equipment Checklist

### Required Field Equipment

- Two D-frame dip nets (500 um mesh)
- Hardware cloth and frame
- Plastic bin for catching material
- 200 um sieve
- Squirt bottles (1 water, 1 alcohol)
- Forceps (one per person)
- Wetland Invertebrate Visit Form
- GPS unit
- Pencils, clipboards
- 100% reagent alcohol
- Chest waders
- Plastic jars for storage
- Permanent marker

### Optional Field Equipment

- Maps for navigation
- Scissors for labels
- Camera to capture site conditions
- Cooler or crate for transporting samples

### Required Lab Equipment

- Stereoscopes (2x--4x magnification)
- Petri dishes
- Identification guides
- Squirt bottles (water or alcohol)
- Dissection tools
- Computer with R and the **macroibi** package

## 3. Collecting Macroinvertebrate Samples

### When to Sample

- Sample **June--early July** while larvae are mature but wetlands retain water.
- Sampling too late risks dried wetlands or transient species.
- If multiple samples are planned, keep all events within this timeframe.

### Where to Sample

Prioritize habitat zones in this order:

1. Emergent vegetation (richest fauna)
2. Floating-leaf vegetation
3. Submerged vegetation
4. Shallow open water

Record the zone(s) used.

### Sampling Procedure

1. **Identify the sampling area.** Select the highest-priority habitat available
   and work within a 10--15 m radius.

2. **Collect two efforts per sample.** For each effort, perform 3--5 strong
   sweeps through vegetation and water. Avoid scraping mud; restart the effort
   if so.

3. **Sort for 10 minutes.** Dump both efforts onto hardware cloth above the bin.
   Start a 10-minute timer and begin sorting (see next section).

4. **Repeat for the second sample.** Stay in the same zone but choose new
   micro-locations. Samples may be combined or kept separate for processing;
   both ultimately contribute to one IBI evaluation.

With larger crews, some people can begin the second sample while others finish
the 10-minute sort; this saves significant time.

## 4. Sorting Samples in the Field

### During the 10-Minute Sorting Window

1. Rinse vegetation so organisms fall into the pans.
2. Pick organisms with forceps into the water-filled pans.
3. After 10 minutes, return vegetation to the wetland; all organisms in the bin
   become the sample.

### After Vegetation Removal

1. Pour pans through the 200 um sieve; flush snails and leeches into the sieve.
2. Back-flush the sieve with alcohol only into sample jars. Aim for
   approximately 80% final concentration. Split jars if more than one-third
   full.
3. Label jars (site ID, date, sample number, jar number, crew initials).
4. Store in hazardous-materials room; check periodically for evaporation.

## 5. Lab Identification and Enumeration

1. **Software Setup** --- Ensure R and MacroIBI are installed (see section 6
   below).

2. **Prepare Workspace** --- Set up stereoscopes, petri dishes, tools, guides,
   and your sample.

3. **Identify and Count Everything**
   - Every individual in the sample must be identified and counted.
   - Family-level ID is required; genus is ideal; species when possible.
   - One person should handle data entry; others relay counts.
   - Pre-sort into visually similar piles to speed identification.
   - Samples may be rinsed with water to reduce irritation, but do not use
     water if samples must remain preserved after identification.

4. **Enter Data Periodically** --- Relay taxa and counts to the data handler for
   entry into the app. Combined samples may all be entered into "Dipnet 1."
   See section 7 for the full app workflow.

## 6. Installing the MacroIBI App

### What You Need

You need two free programs:

- **R** --- The engine that powers the app. You will not interact with it
  directly.
- **RStudio** --- The program you will actually use. It provides a
  user-friendly interface for running R commands.

Think of R as the engine and RStudio as the dashboard of a car --- you need
both, but you only interact with the dashboard.

### Step 1: Install R

1. Go to <https://cran.r-project.org>
2. Click the download link for your operating system:
   - **Windows:** Click "Download R for Windows" then "base" then
     "Download R-4.x.x for Windows"
   - **Mac:** Click "Download R for macOS" and choose the version for your Mac
3. Open the downloaded file and run the installer
4. Accept all default options

### Step 2: Install RStudio

1. Go to <https://posit.co/download/rstudio-desktop/>
2. Scroll down to "All Installers" and click the download for your OS
3. Run the installer with default options

### Step 3: Install Rtools (Windows Only)

This step is required on Windows. Rtools allows R to install packages that need
compilation.

1. Go to <https://cran.r-project.org/bin/windows/Rtools/>
2. Download "Rtools44" (or the version matching your R version)
3. Run the installer with default options

Mac users can skip this step.

### Step 4: Open RStudio and Install MacroIBI

Open RStudio and find the **Console** --- the panel with a `>` symbol, usually
in the bottom-left area. Type each command below and press Enter:

```{r install}
install.packages("remotes")
remotes::install_github("aomop/MacroIBI")
```

You will see text scrolling as R downloads and installs packages. This is
normal and may take 1--2 minutes.

### Step 5: Launch the App

```{r launch}
library(macroibi)
run_macroibi()
```

A browser window will open with the Wetland IBI Dashboard.

### Quick Verification

To confirm everything works, try demo mode:

```{r demo}
run_macroibi(demo_mode = TRUE)
```

Click "OK" on the demo message, then click **Load Autosave** on the left
sidebar. If you see demo files listed, everything is working correctly.

### Closing the App

- Close the browser tab, OR
- In RStudio, click the red Stop button in the Console area, OR
- Press the Escape key while clicked in the Console

### Troubleshooting

- **"Error: package 'remotes' is not available"** --- Run
  `install.packages("remotes")` first.
- **Red text mentioning "Rtools" or "compilation" (Windows)** --- Install
  Rtools (step 3), restart RStudio, and try again.
- **"Cannot open URL" or network errors** --- Check your internet connection.
  If on a work network, try from home or contact IT about firewall restrictions.
- **PDF/image export not working** --- Run `webshot2::install_phantomjs()` in
  the Console.
- **App will not start / "could not find function"** --- Make sure you ran
  `library(macroibi)` first. This is required every time you open RStudio.
- **Still stuck?** --- Open an issue at
  <https://github.com/aomop/MacroIBI/issues>.

## 7. Using the MacroIBI App

### Enter Metadata

When the app opens, enter a **sample title** and **date**, then click
**Let's go!**. You can also continue without metadata if you plan to upload
data or reload an autosave.

### Step 1: Enable Autosave

On the Data tab, find **Autosave Settings** on the left sidebar and enable
auto-save. Autosave will:

- Periodically save your progress
- Store autosaves per user
- Allow recovery after crashes
- Provide history for reports and comparisons

You can reload autosaves using **Load Autosave**.

Data Summary and Full Report features rely on having autosaves available.

### Step 2: Enter Taxa and Counts

Use **Select Taxon** to search and add taxa. The app assigns each taxon to the
correct group automatically.

Each row displays:

- Taxon name
- Dipnet 1 count
- Dipnet 2 count
- Sum count (auto-calculated)

Group footers update live with total taxa, percent of total sample, and total
individuals.

### Step 3: Review Metrics

Switch to the **Results** tab to see real-time IBI calculations:

- **Total individuals** --- Sum of all individuals across both dipnets and all
  groups.
- **EOT richness** --- Number of unique taxa in Dragonflies, Mayflies,
  Damselflies, and Caddisflies (EOT orders).
- **Snail richness** --- Number of unique taxa in Gastropoda.
- **All-taxa richness** --- Sum of unique taxa across all groups.
- **Corixid ratio** --- Corixidae individuals divided by the sum of all true
  bugs and beetles. Higher ratios indicate potential nutrient loading.
- **Abundance of EOT** --- Total EOT individuals divided by total individuals.
- **IBI Score (0--50)** --- Sum of five adjusted metric scores (each 0--10).
  Scores are scaled between anchor percentiles from reference data.

Hover over *"How are these calculated?"* in the app for metric formulas.

#### Scoring Details

Metrics that **decrease** with disturbance are scored on these ranges:

- EOT richness: 1--12 taxa
- Snail richness: 1--10 taxa
- All-taxa richness: 10--40 taxa
- Abundance of EOT: 0--0.16

The **corixid ratio** increases with disturbance and uses anchors of 0 (best)
to 1.0 (worst), with a 5th--95th percentile band of 0--0.82. Values above the
maximum anchor score 0.

Each component score is capped at 0--10. The final IBI score is their sum
(maximum 50).

### Step 4: Export Results

Available downloads:

- **Raw Data CSV** --- For archiving or re-uploading into the app. Use only CSVs
  exported from MacroIBI without external edits.
- **Results CSV** --- Final calculated scores.
- **Table Image (PNG)** --- Formatted metric table with titles and dates.
- **Data Summary (PDF)** --- Concise one-page snapshot of metrics.
- **Full Report (PDF)** --- Comprehensive report including current metrics and
  comparisons to other autosaved sessions.

Reports require autosave history to generate comparisons.

## 8. Additional Features

### Taxonomic Hierarchy Viewer

Use **Show/Hide Taxonomic Hierarchy** to view a taxonomic tree of selected
taxa. This helps verify correct grouping.

### Reloading Old Work

Upload any previously exported **Raw Data CSV** to restore tables exactly as
saved.

### Clearing Data

**Clear All Data** resets everything. This cannot be undone if the data has not
been saved.

### Batch Export

For scripted or automated workflows, see
`vignette("batch-export", package = "macroibi")`.
